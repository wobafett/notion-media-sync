name: Notion IGDb Sync

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      last_page_only:
        description: 'Sync only the last edited page'
        required: false
        default: false
        type: boolean
      workers:
        description: 'Number of parallel workers (1-4)'
        required: false
        default: '3'
        type: string
      force_icons:
        description: 'Force update all page icons'
        required: false
        default: false
        type: boolean
  
  # Scheduled runs - always full sync
  # schedule:
    # Run every 6 hours
    # - cron: '0 */6 * * *'
  
  # Trigger on push to main branch - always full sync
  push:
    branches:
      - main
    paths:
      - 'notion_igdb_sync.py'
      - 'sync_last_page.py'
      - 'property_config.py'
  
  # Webhook trigger from Make.com for page-specific syncs
  repository_dispatch:
    types: [sync]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Sync
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        IGDB_CLIENT_ID: ${{ secrets.IGDB_CLIENT_ID }}
        IGDB_CLIENT_SECRET: ${{ secrets.IGDB_CLIENT_SECRET }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        LOG_LEVEL: INFO
        GITHUB_EVENT_NAME: ${{ github.event_name }}
      run: |
        if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
          PAGE_ID="${{ github.event.client_payload.page_id }}"
          if [ -z "$PAGE_ID" ]; then
            echo "‚ùå Error: repository_dispatch triggered without page_id"
            exit 1
          fi
          echo "üéÆ Running page-specific sync for page: $PAGE_ID (webhook trigger)..."
          python notion_igdb_sync.py --page-id "$PAGE_ID" --workers ${{ github.event.client_payload.workers || '3' }} \
            ${{ github.event.client_payload.force_all && '--force-all' || '' }}
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.last_page_only }}" = "true" ]; then
          echo "üéÆ Running last page sync (manual trigger)..."
          python notion_igdb_sync.py --last-page --workers ${{ github.event.inputs.workers || '3' }} \
            ${{ github.event.inputs.force_icons && '--force-icons' || '' }}
        else
          echo "üéÆ Running full sync (triggered by: ${{ github.event_name }})..."
          python notion_igdb_sync.py --workers ${{ github.event.inputs.workers || '3' }} \
            ${{ github.event.inputs.force_icons && '--force-icons' || '' }}
        fi
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sync-logs-${{ github.run_number }}
        path: notion_igdb_sync.log
        retention-days: 7
